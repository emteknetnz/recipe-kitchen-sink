name: php81-ci

on:
  push:
  workflow_dispatch:

jobs:
  tests:
    runs-on: ubuntu-latest

    strategy:
      # set fail-fast to false prevent one job from cancelling other jobs
      fail-fast: false
      matrix:
        include:
          - php: 7.4
            phpunit_suite: recipe-core
          - php: 8.1
            phpunit_suite: recipe-core

    services:
      mysql:
        image: mysql:5.7
        env:
          MYSQL_HOST: 127.0.0.1
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: SS_mysite
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    name: PHP ${{ matrix.php }} ${{ matrix.phpunit_suite }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: curl, dom, gd, intl, json, ldap, mbstring, mysql, tidy, xdebug, zip
          tools: composer:v2
          coverage: xdebug
        # While this should be the correct way to allow forks in composer.json repositories
        # in practice there are still many sporadic "Could not authenticate against github.com" errors
        # there's 1,000 requests per hour limit when using this token, likely it get exceeded
        # fairly easily when using a fork with multiple jobs in a matrix
        #env:
        #  COMPOSER_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure PHP
        run: |
          # Set memory limit and disable xdebug if not running phpcoverage
          if [ ! $(which php) ]; then echo "PHP not installed, skipping" && exit 0; fi
          # github linux runners have 7GB of RAM
          # https://docs.github.com/en/actions/using-github-hosted-runners/about-github-hosted-runners
          # Set a high memory limit, particularly for php coverage tests
          PHP_MEMORY_LIMIT=6144M
          echo "PHP_MEMORY_LIMIT is $PHP_MEMORY_LIMIT"
          sudo sh -c "echo 'memory_limit = $PHP_MEMORY_LIMIT' >> /etc/php/${{ matrix.php }}/cli/php.ini"
          if [ -f /etc/php/${{ matrix.php }}/apache2/php.ini ]; then
            sudo sh -c "echo 'memory_limit = $PHP_MEMORY_LIMIT' >> /etc/php/${{ matrix.php }}/apache2/php.ini"
          fi
          # Disable xdebug which greatly slow down unit testing
          # Note: omitting xdebug from shivammathur/setup-php still results in xdebug being installed and enabled
          sudo sh -c "echo ';zend_extension=xdebug.so' > /etc/php/${{ matrix.php }}/mods-available/xdebug.ini"
          echo "PHP has been configured"

      - name: Apt install additional requirements 
        run: |
          sudo apt install -y hunspell libhunspell-dev hunspell-en-us

      # This is shared between runs, not just jobs. It means the first time the repo runs the job it'll
      # need to download requirements for the first time, after that it will be plenty quick
      # https://docs.github.com/en/actions/advanced-guides/caching-dependencies-to-speed-up-workflows
      - name: Enable shared composer cache
        uses: actions/cache@v2
        with:
          path: ~/.cache/composer
          key: shared-composer-cache

      - name: Composer
        run: |
          COMPOSER_ROOT_VERSION=4.x-dev
          composer require mikey179/vfsstream:^1 --dev --no-update
          cat composer.json
          composer update --prefer-source --no-interaction --no-progress

      - name: Manually checkout branches from creative-commoners
        run: |
          PWD=$(pwd)
          for VENDOR in silverstripe cwp dnadesign symbiote bringyourownideas tractorcow colymba; do
            for DIR in $PWD/vendor/$VENDOR/*; do
              if [ -d $DIR ]; then
                echo "Processing $DIR"
                cd $DIR
                ORIGIN=$(git config --get remote.origin.url)
                if ! [ -z "$ORIGIN" ]; then
                  CCS_REMOTE=$(php -r "\$s=str_replace(['silverstripe/','dnadesign/','symbiote/','bringyourownideas/','tractorcow/','tractorcow-farm/','colymba/'],'creative-commoners/', '$ORIGIN');\$s=str_replace(['git@github.com:','.git'],['https://github.com/',''],\$s);echo \$s;")
                  CODE=$(curl -s -o /dev/null -w "%{http_code}" $CCS_REMOTE)
                  if [ "$CODE" == "200" ]; then
                    git remote add ccs $CCS_REMOTE
                    git fetch ccs
                    BRANCH=$(git rev-parse --abbrev-ref HEAD)
                    if [ "$BRANCH" != "HEAD" ]; then
                      NEW_BRANCH=pulls/$BRANCH/php81
                      if ! [ -z $(git show-branch remotes/ccs/$NEW_BRANCH 2> /dev/null) ]; then
                        git checkout $NEW_BRANCH
                        git log -1
                      else
                        echo "Branch $NEW_BRANCH does not exist, continuing..."
                      fi
                    else
                      echo "Using non-dev branch, continuing..."
                    fi
                  else
                    echo "Remote $CCS_REMOTE does not exist, continuing..."
                  fi
                else
                  echo "No origin for $DIR, continuing..."
                fi
              fi
            done
          done

      - name: Final preparation
        run: |
          # Add .env file and create artifacts directory
          cat << EOF > .env
          SS_ENVIRONMENT_TYPE="dev"
          SS_DATABASE_CLASS="MySQLDatabase"
          SS_DATABASE_SERVER="127.0.0.1"
          SS_DATABASE_USERNAME="root"
          SS_DATABASE_PASSWORD="root"
          SS_DATABASE_NAME="SS_mysite"
          SS_DEFAULT_ADMIN_USERNAME="admin"
          SS_DEFAULT_ADMIN_PASSWORD="password"
          SS_TRUSTED_PROXY_IPS="*"
          SS_MFA_SECRET_KEY="1234567894175b99966561e1efe237e4"
          SS_BASE_URL="http://localhost"
          EOF
          
          # Don't actually need to dev/build flush=1 here, is more for debugging
          # vendor/bin/sake dev/build flush=1
          # Is failing on 
          # * SilverStripe\ErrorPage\ErrorPage
          # ERROR [Emergency]: Uncaught Error: Call to undefined method SilverStripe\Core\Manifest\VersionProvider::singleton()
          # IN GET dev/build
          # Line 1496 in /home/runner/work/recipe-kitchen-sink/recipe-kitchen-sink/vendor/silverstripe/cms/code/Model/SiteTree.php
          
          # Delete the silverstripe-cache dir - it will automatically recreate when needed
          # There were issues with a unit test getting the following issue
          # Identifier name 'SilverStripe_CampaignAdmin_Tests_AddToCampaignValidatorTest_TestObject' is too long
          # Likely because the /tmp/silverstripe-cache-php7.4.xyz... dir being out of sync with TestOnly objects
          rm -rf $(find /tmp -maxdepth 1 | grep silverstripe-cache)

      - name: Run tests
        uses: emteknetnz/gha-run-tests@main
        with:
          phpunit: true
          phpunit_suite: ${{ matrix.phpunit_suite }}
